---
project: fo_organization
layout: "post"
title: "Intro to Visualization - 2 Using Facet Plots"
date: "2023-06-26"
author: "Prasann Ranade"
categories: [viz, tools, facets]
tags: [r]
output: word_document
---

# Intro to Visualization - 2 Using Facet Plots for Select OUs

# Agenda:

[1. Overview]

[2. Data Importing and Cleaning]

[3. Visualizing your data]

```{r warnings = FALSE, include = FALSE, message = FALSE}
library(tidyverse)
library(glitr)
library(glamr)
library(gophr)
library(extrafont)
library(scales)
library(tidytext)
library(patchwork)
library(ggtext)
library(glue)
```

# 1. Overview

In this script, we'll walk through creating a facet plot comparing indicator results across a set of OUs (or planets in this case). We'll first import and clean our dataset, perform some additional filtering by indicators and groups, and then visualize and adorn our plot.

# 2. Data Importing and Cleaning

As we want to display our plots across a range of x or y values, we want to make sure that we clearly extract these values from the original dataset by specific fiscal years and counts. Next, we can aggregate our numbers to specific levels to aid in faceting; in this case, we summarize values for each indicator by planet and fiscal year.

```{r warnings = FALSE}
# import training dataset
df <- si_path() %>% 
  return_latest("FY48-49") %>% 
  read_csv() 

df_tx <- df %>% 
  # filter to these values
  filter(indicator %in% c("TX_CURR", "TX_NEW", "HTS_TST_POS"),
         disaggregate %in% "Total Numerator") %>% 
  
  # choose which columns to copy over to your new dataset
  select(planet,fiscal_year, indicator, cumulative) %>% 
  
  # choose the order to group rows by (ex. by planet first then indicator)
  group_by(planet,indicator, fiscal_year) %>% 
  
  # sum up values for each indicator across all regions
  summarize(across(cumulative, sum, na.rm = TRUE)) %>% 

  # rename the fiscal_year  and cumulative columns
  rename(period = fiscal_year, value = cumulative) %>%
  mutate(period = str_replace(period, "20", "FY")) %>%
  
  # ungroup columns after doing any data manipulation
  ungroup()

# show new dataframe
View(df_tx)
```

# 3. Visualizing your data

Using "small multiples" of charts to present the same result across a set of values allows you to easily compare and contrast multiple items. Here, we are plotting results across planets (as in the training dataset) and indicators, though regions, OUs, indicators, and fiscal years are other possible options. Specifically, as this training dataset only includes three planets (OUs) and three indicators, grouping across both allows us to view more specific plots.Let's start with a basic facet plot showing the cumulative values for each year (FY48-49) across all three planets.

Key functions:
- facet_wrap: as oppposed to a facet_grid, facet_wrap only arranges plots in rows, with the title strip located at the top

```{r warning = FALSE}
df_viz <- df_tx %>% 
  # provide x and y aesthetics to the ggplot function
  ggplot(aes(x = period, y = value)) +
  
  # create a column graph (not a bar graph)
  geom_col() +
  
  # arrange the plots by planet
  facet_wrap(~ planet, strip.position = "top") 
  
  # follow the SI ygrid style
  #si_style_ygrid()

plot(df_viz)

```
Now let's try a facet grid to arrange the small plots in a 3x3 grid of planets x indicators.

Key functions:
- geom_area: create an area plot filled-in with color
- scale_y_continuous: add a continuous scale to the y axis
- si_style_ygrid: arrange axis and gridlines according to the SI ygrid style

```{r warning = FALSE}
df_viz <- df_tx %>% 
  # provide x and y aesthetics to the ggplot function
  ggplot(aes(x = period, y = value, group = planet)) +
  
  # create a column graph (not a bar graph)
  geom_area() +

  # arrange the plots by planet
  facet_grid(indicator ~ planet) +
  scale_y_continuous() +

  # follow the SI ygrid style
  si_style_ygrid()

plot(df_viz)
```
And now let's add color for the area plots, clearer text and axis labels, and a proper title and caption.

Key functions:
- geom_point: adds a point object to the ggplot frame (here to point out specific values)
- scale_x_discrete: ensure the x axis is scaled discretely (not continuously)
- labs: add text for x axis, y axis, title, subtitle, and caption
- glue: include the value of a variable within normal text 

``` {r}
df_viz <- df_tx %>% 
  ggplot(aes(x = period, y = value, group = planet)) + 
  geom_area(fill = scooter, color = scooter, alpha = .2, size = 1, na.rm = TRUE) +
  geom_point(shape = 21, fill = "white", color = scooter, stroke = 1.5, na.rm = TRUE) +
  scale_y_continuous(label = label_number_si(), position = "left") +
  scale_x_discrete() +
  facet_grid(indicator ~ planet, scales = "free") + # facet by two columns
  labs(x = NULL, y = NULL, 
       title = glue("SATURN has been leading in improvements to testing
       and treatment among all planets across 2048-49") %>% toupper,
       subtitle = "Facet Plot by OU and Indicator",
       caption = glue("Source: SI analytics
                       US Agency for International Development")) +
  si_style_ygrid()
plot(df_viz)
```
Looks great! We can see that TX_CURR has the greatest numbers across all three indicators, and that Jupiter has the greatest numbers across all three planets. Now let's save this visual according to the following dimensions.  

```{r eval = FALSE}
# use the glue function to add a title and file format (ex. svg or png)
si_save(glue("Graphics/FO_Viz_Facet.svg"), height = 4, width = 10, scale = 1.3)
si_save(glue("Images/FO_Viz_Facet.png"), height = 4, width = 10, scale = 1.3)  
```
