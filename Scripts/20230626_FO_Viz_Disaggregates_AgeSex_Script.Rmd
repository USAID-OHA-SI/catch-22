---
project: fo_organization
layout: "post"
title: "Intro to Visualization - 3 Age/Sex Disaggregates"
date: "2023-06-26"
author: "Prasann Ranade"
categories: [viz, tools, disaggregates]
tags: [r]
output: word_document
---

# Intro to Visualization - 3 Age/Sex Disaggregates

## Agenda:
[ 1. Overview ]
[ 2. Data Cleaning: how do I get a relevant subset of the dataframe? ]
[ 3. Additional data filtering prior to visualization ]
[ 4. Visualizing your data ]

``` {r warnings = FALSE, include = FALSE, message = FALSE}
library(tidyverse)
library(glitr)
library(glamr)
library(gophr)
library(extrafont)
library(scales)
library(tidytext)
library(patchwork)
library(ggtext)
library(glue)
library(gt)
library(webshot2)
```

# 1. Overview

This script will follow the same structure as the others: we will begin with a brief discussion of standardized disaggregates, then move onto ways to subset those disaggregates from a total dataframe of results and targets for a set of indicators, then prep the dataframe for visualization, create a visual using ggplot, and end by saving the visual as an svg and png file.

Standardized disaggregates look at a subset of the population across categories like age, sex, and treatment modality, and paying attention to these categories allows us to discover disparities in testing and treatment across age, sex, and KP groups. In this script, we'll walk through identifying four groups (Peds, AGYW, KP, and Adult Men) and the Total Numerator across the entire dataframe with regards to their achievement. 

``` {r}
# import training dataset
df <- si_path() %>% 
  return_latest("OU_IM_FY21-23") %>% 
  read_psd() 

# calculate total results and targets for USAID wrt 3 indicators across 2021-23
df_totals <- df %>%  
  # similar filtering steps as the others 
  filter(funding_agency == "USAID",
         indicator %in% c("TX_CURR", "TX_NEW", "HTS_TST_POS"),
         standardizeddisaggregate %in% "Total Numerator") %>% 
  select(fiscal_year, funding_agency, indicator, cumulative, targets) %>% 
  group_by(fiscal_year, funding_agency, indicator) %>%
  
  # pull out cumulative and target columns
  summarise(across(matches("cumulative|target"), sum, na.rm = TRUE)) %>% 
  ungroup() %>%
  
  # rename for easy inference
  rename(results_all=cumulative, targets_all=targets)
```

After subsetting the original dataframe to the particular columns of interest, let's write out our four populations and their respective standardized disaaggregates, in order to create a dataframe for each population and for the total population. The if-else statements below create a boolean (TRUE/FALSE) column that displays what population is selected and attaches the corresponding group label. Here, let's choose the AGYW population for visualization.

``` {r warnings = FALSE}
# all possible populations and their standardized disaggregates for reference

#pop_sel<-"ALL"
#std_dis<-"Total Numerator"
#pop_sel<-"PEDS"
#std_dis<-c("Age/Sex/HIVStatus", "Age/Sex/HIVStatus", "Modality/Age/Sex/Result")
pop_sel<-"AGYW"
std_dis<-c("Age/Sex/HIVStatus", "Age/Sex/HIVStatus", "Modality/Age/Sex/Result")
#pop_sel<-"KP"
#std_dis<-c("KeyPop/HIVStatus", "KeyPop/HIVStatus", "KeyPop/Result")
# pop_sel<-"ADULT_MEN"
# std_dis<-c("Age/Sex/HIVStatus", "Age/Sex/HIVStatus", "Modality/Age/Sex/Result")
```

Let's first create our totals dataframe that contains targets and results across the entire population, for use as a reference against the small population-level achievement numbers.

``` {r warnings = FALSE}
# filter to given standardized disaggregate
df_tx_all <- df %>%  
  filter(funding_agency == "USAID",
         indicator %in% c("TX_CURR", "TX_NEW", "HTS_TST_POS"),
         
         # from the above chunk, we have chosen the disaggreagate for the adult male population 
         standardizeddisaggregate %in% std_dis) %>% 
  
         # also pull out treends, age, and other disaggregate columns 
         select(fiscal_year, funding_agency, indicator, sex, trendscoarse, 
                ageasentered, otherdisaggregate, cumulative, targets) 
```

Now let's subset this total dataframe for the particular AGYW population that we're interested in.

``` {r}
## add a population filter column (pop) to select a population with a boolean operator
# repeat this if-else condition for all key populatios 
if (pop_sel=="PEDS"){
  # create a subset dataframe from the modified dataframe created above
  df_tx<- df_tx_all %>%
  # add a population filter column with a boolean operator
  mutate(pop=ifelse(trendscoarse=="<15", TRUE, FALSE))
  # add label for the group
  group_label<-"USAID, Children under 15"
  
  # keep going for the rest of the key populations
  } else if (pop_sel=="AGYW"){
    df_tx<- df_tx_all %>% 
    mutate(pop=ifelse(ageasentered %in% c("15-19", "20-24") & sex=="Female", TRUE, FALSE))
  group_label<-"USAID, Females 15-24"
  
  } else if (pop_sel=="KP"){
    df_tx<- df_tx_all %>% mutate(pop=TRUE)
   group_label<-"USAID, Key Populations"
  
  } else if (pop_sel=="ADULT_MEN"){
    df_tx<- df_tx_all %>% 
    mutate(pop=ifelse(trendscoarse=="15+" & sex=="Male", TRUE, FALSE))
   group_label<-"USAID, Males 15+"
  } else {
    df_tx<- df_tx_all %>% mutate(pop=TRUE)
  group_label<-"USAID, all populations"}
```  

Using this dataframe, let's clean up the names of columns, add achievement colors using the adorn_achievement function, and prepare it for visualization.

``` {r warnings = FALSE}
# add in adorn_achievement and add indicator labels for a given population
df_viz<- df_tx %>% filter(pop==TRUE) %>%
        group_by(fiscal_year, funding_agency, indicator) %>%
        summarise(across(matches("cumulative|target"), sum, na.rm = TRUE)) %>% 
        ungroup() %>% 
  
        # calculate achievement and add colors via the adorn_achievement function 
        adorn_achievement() %>% 
        
        # rename column names and add a source and indicator labels                             
        rename(period = fiscal_year, value = cumulative) %>% 
        mutate(period = str_replace(period, "20", "FY")) %>% 
        arrange(indicator, period) %>% 
        mutate(source = "MSD") %>%
        mutate(indicator=fct_relevel(indicator,"HTS_TST_POS", "TX_NEW", "TX_CURR")) %>%
        mutate(ind_label = case_when(indicator == "TX_CURR" ~ "Currently receiving ART",
                                         indicator == "HTS_TST_POS" ~ "Received positive result",
                                         TRUE ~ "Newly enrolled on ART")) %>% 
        mutate(achievement = achievement * 100) 

df_viz$achievement <- paste0(as.matrix(df_viz$achievement), '%')
```            
With all that setup, let's create our first visual! Let's follow the same facet grid format we've used for the other scripts and aim to show targets vs. results bars.

``` {r}
nudge_space <- 0.125

df_plot <- df_viz %>% 
  ggplot(aes(x = indicator, group = indicator, fill=achv_color)) +
  # add a targets bar in grey slightly off-center
  geom_col(aes(y = targets), fill = grey10k, width = 0.5, position = position_nudge(x = -nudge_space)) +
  # add a results bar in color slightly off-center
  geom_col(aes(y = value), fill = df_viz$achv_color, width = 0.5, position = position_nudge(x = nudge_space)) +
  
  facet_grid(period ~ indicator, scales = "free") +

  # add scales and grids to chart and remove the legend
  scale_y_continuous(label = label_number_si(), position = "left") +
  scale_x_discrete() +
  si_style_ygrid() +
  theme(legend.position = "none") + # remove legend from plot+

  #geom_text(aes(label = glue{achievement,"%"}, vjust = 1.5, colour = "#000000")) +
  
  # add population label in the caption
  labs(x = NULL, y = NULL, fill = NULL,
       title = glue("Targets vs. Results for Sample Indicators"), 
       caption = c(glue("Data: {group_label}
                         Source: MSD OUxIM FY21-23) 
                         Created by: USAID OHA SI Team")))

plot(df_plot)
```
This first visual uses colors to display which indicators belong to which achievement thresholds during a certain year with green => 110%, 90% <= red <= 110%, and blue < 90%. And the title, caption, and axis labels seem accurate, so let's experiment with other plot styles.

``` {r}
df_plot <- df_viz %>% 
  ggplot(aes(x = indicator, group = indicator, fill=achv_color)) +
  
  # add a results bar in color slightly off-center
  geom_bar(aes(y = value), fill = df_viz$achv_color, width = 0.5, position = position_nudge(x = nudge_space), stat = "identity") +
  

  # add scales and grids to chart and remove the legend
  scale_y_continuous(labels = percent, position = "left") +
  scale_x_discrete() +
  si_style_ygrid() +
  theme(legend.position = "none") + # remove legend from plot+

  #geom_text(aes(label = glue{achievement,"%"}, vjust = 1.5, colour = "#000000")) +
  
  # add population label in the caption
  labs(x = NULL, y = NULL, fill = NULL,
       title = glue("Targets vs. Results for Sample Indicators"), 
       caption = c(glue("Data: {group_label}
                         Source: MSD OUxIM FY21-23) 
                         Created by: USAID OHA SI Team")))

plot(df_plot)
```
This stacked bar looks a little confusing because it combines achievement values for each indicator for AGYW across all 3 years. But let's calculate the specific values of targetss vs. results for the AGYW population and see how it compares.

Extra credit: Let's create a table to calculate how achievement for the AGYW population compares to that for the entire population.

``` {r}
## Calculate percent

## Total results and targets for subgroup
subgrp_tot<-df_tx %>% group_by(fiscal_year, funding_agency, indicator) %>%
  filter(pop==TRUE) %>%
  summarise(across(matches("cumulative|target"), sum, na.rm = TRUE)) %>% 
  ungroup() %>%
  rename(res_subgrp=cumulative, tar_subgrp=targets)

# calculate percentage of achievement for a particular population
percent_prog<-full_join(subgrp_tot,df_totals, by=c("fiscal_year", "funding_agency","indicator")) %>%
  mutate(res_per=round(res_subgrp/results_all*100),tar_per=round(tar_subgrp/targets_all*100)) %>%
  filter(fiscal_year=="2022") %>%
  select(indicator, results_all,res_subgrp,res_per,targets_all,tar_subgrp,tar_per)

# use the gt library to combine the calculations for results and targets into one table
percent_prog %>%
  gt() %>%
  cols_label(results_all="Results All", res_subgrp=glue("Results {pop_sel}"), res_per="Results %",
             targets_all="Targets All", tar_subgrp=glue("Results {pop_sel}"), tar_per="Targets %") 
```

Great, we have a good set of calculations and visuals, and lastly, let's save our visuals.

``` {r}
#gtsave(percent_prog,"Users/STAR/Documents/Images/2021-23_percent_programs_AGYW.png")
#si_save(glue("Graphics/2021-23_TX_trends_ou_gaps_{pop_sel}.svg"), height = 4, width = 10, scale = 1.3)
#si_save(glue("Images/2021-23_TX_trends_ou_gaps_{pop_sel}.png"), height = 4, width = 10, scale = 1.3)  
```
```
